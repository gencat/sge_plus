<% add_decidim_meta_tags(
  description: translated_attribute(current_candidacy.description),
  title: translated_attribute(current_candidacy.title),
  url: candidacy_url(current_candidacy.id),
  resource: current_candidacy) %>

<%
edit_link(
  resource_locator(current_participatory_space).edit,
  :read,
  :candidacy
)
%>

<%= content_for :aside do %>
  <section class="candidacy__aside">
    <% if current_candidacy.published? || current_candidacy.rejected? || current_candidacy.accepted? || current_candidacy.discarded? %>
      <% if current_candidacy.votes_enabled? %>
        <section class="layout-aside__section layout-aside__buttons" id="candidacy-<%= current_candidacy.id %>-vote-cabin">
          <%= render partial: "vote_cabin", locals: { candidacy: current_candidacy } %>
        </section>
      <% end %>
    <% else %>
      <% if allowed_to?(:edit, :candidacy, candidacy: current_candidacy) || allowed_to?(:send_to_technical_validation, :candidacy, candidacy: current_candidacy) %>
        <section class="layout-aside__section layout-aside__buttons">
          <% if allowed_to? :edit, :candidacy, candidacy: current_candidacy %>
            <%= link_to t(".edit"),
                        edit_candidacy_path(current_candidacy),
                        class: "button button__xl w-full button__secondary" %>
          <% end %>

          <% if allowed_to? :send_to_technical_validation, :candidacy, candidacy: current_candidacy %>
            <%= link_to t(".send_to_technical_validation"),
                        send_to_technical_validation_candidacy_path(current_candidacy),
                        class: "button button__xl w-full button__secondary mt-4",
                        data: { confirm: t(".confirm") } %>
          <% end %>
        </section>
      <% end %>
    <% end %>

    <% unless current_candidacy.validating? %>
      <section class="layout-aside__section">
        <%= render partial: "progress_bar" %>
      </section>
    <% end %>

    <% if current_candidacy.type.promoting_committee_enabled? && current_user&.admin? %>
      <div class="layout-aside__section">
        <div class="candidacy__aside__element__committee">
          <%= icon "account-circle-line", class: "fill-gray inline-block" %>
          <span class="ml-2 candidacy__aside__element-title">
            <%= t("title", scope: "decidim.signature_collection.admin.committee_requests.index") %>
          </span>
          <div class="ml-auto fill-secondary inline-block">
            <input id="urlShareLink-committee" type="text" class="!hidden" value="<%= decidim_candidacies.new_candidacy_committee_request_url(current_candidacy) %>" readonly>
            <button type="button" class="button button__sm button__text-secondary" data-clipboard-copy="#urlShareLink-committee">
              <%= render_committee_tooltip %>
              <span class="sr-only"><%= t("decidim.shared.share_modal.copy_share_link") %></span>
            </button>
          </div>
        </div>
          <% if current_candidacy.committee_members.empty? %>
            <span class="candidacy__aside__element__data-text">
              <%= t("no_members_yet", scope: "decidim.signature_collection.admin.committee_requests.index") %>
            </span>
          <% end %>
          <% current_candidacy.committee_members.each do |request| %>
            <div class="author" data-id="<%= request.id %>">
              <div class="profile__group__list">
                <%= card_for request.user %>
              </div>
            </div>
          <% end %>
      </div>
    <% end %>

    <% if allowed_to?(:export_pdf_signatures, :candidacy, candidacy: current_candidacy) ||
          allowed_to?(:export_votes, :candidacy, candidacy: current_candidacy) ||
          allowed_to?(:export_xml_signatures, :candidacy, candidacy: current_candidacy) %>
      <section class="layout-aside__section">
        <details class="w-full">
          <summary class="exports button button__xl button__secondary w-full flex items-center justify-between">
            <span><%= t("export_signatures", scope: "decidim.signature_collection.candidacies.show") %></span>
            <%= icon "arrow-down-s-line", class: "dropdown-filter-icon" %>
          </summary>
          <ul class="vertical menu add-components mt-2">
            <% if allowed_to? :export_pdf_signatures, :candidacy, candidacy: current_candidacy %>
              <li>
                <%= link_to t("export_pdf_signatures", scope: "decidim.signature_collection.edit"),
                            export_pdf_signatures_candidacy_path(current_candidacy, format: :pdf),
                            class: "button button__sm button__secondary w-full" %>
              </li>
            <% end %>
            <% if allowed_to? :export_votes, :candidacy, candidacy: current_candidacy %>
              <li class="mt-2">
                <%= link_to t("export_csv_votes", scope: "decidim.signature_collection.edit"),
                            export_votes_candidacy_path(current_candidacy, format: :csv),
                            class: "button button__sm button__secondary w-full" %>
              </li>
            <% end %>
            <% if allowed_to? :export_xml_signatures, :candidacy, candidacy: current_candidacy %>
              <li class="mt-2">
                <%= link_to t("export_xml_signatures", scope: "decidim.signature_collection.edit"),
                            export_xml_signatures_candidacy_path(current_candidacy),
                            class: "button button__sm button__secondary w-full" %>
              </li>
            <% end %>
          </ul>
        </details>
      </section>
    <% end %>

    <section class="layout-aside__section">
      <div class="mb-6">
        <%= icon "apps-line", class: "fill-gray inline-block" %>
        <span class="candidacy__aside__element-title">
          <%= t("candidacy_data", scope: "decidim.signature_collection.candidacies.show") %>
        </span>
      </div>

      <div class="candidacy__aside__element__data">
        <p class="candidacy__aside__element__data-title">
          <%= t("state", scope: "decidim.signature_collection.candidacies.show") %>
        </p>
        <span class="candidacy__aside__element__data-text">
          <%= render partial: "candidacy_badge", locals: { candidacy: current_candidacy } %>
        </span>
      </div>

      <div class="candidacy__aside__element__data">
        <p class="candidacy__aside__element__data-title">
          <%= t("label", scope: "decidim.signature_collection.candidacies.show.signature_period") %>
        </p>
        <span class="candidacy__aside__element__data-text">
          <%= current_candidacy.signature_period_description %>
        </span>
      </div>

      <% if current_candidacy.offline_signature_type? || current_candidacy.online_signature_type? %>
        <div class="candidacy__aside__element__data">
          <p class="candidacy__aside__element__data-title">
          <%= t("signature_collection", scope: "decidim.signature_collection.candidacies.show") %>
          </p>
          <span class="candidacy__aside__element__data-text">
            <span class="text-sm font-normal text-gray-2 block">
              <% if current_candidacy.offline_signature_type? %>
                <%= t("offline", scope: "activemodel.attributes.candidacy.signature_type_values") %>
              <% end %>
              <% if current_candidacy.online_signature_type? %>
                <%= t("online", scope: "activemodel.attributes.candidacy.signature_type_values") %>
              <% end %>
            </span>
          </span>
        </div>
      <% end %>

      <% if current_candidacy.type.minimum_signing_age? %>
        <div class="candidacy__aside__element__data">
          <p class="candidacy__aside__element__data-title">
          <%= t("minimum_signing_age", scope: "decidim.signature_collection.candidacies.show") %>
          </p>
          <span class="candidacy__aside__element__data-text">
            <span class="text-sm font-normal text-gray-2 block">
              <%= current_candidacy.type.minimum_signing_age %>
            </span>
          </span>
        </div>
      <% end %>

      <div class="candidacy__aside__element__data">
        <p class="candidacy__aside__element__data-title">
          <%= t("scope", scope: "decidim.signature_collection.candidacies.show") %>
        </p>
        <span class="candidacy__aside__element__data-text">
          <span class="text-sm font-normal text-gray-2 block">
            <%= link_to translated_attribute(current_candidacy.scope_name), candidacies_path(filter: { with_any_scope: [current_candidacy.scope&.id] }) %>
          </span>
        </span>
      </div>

      <div class="candidacy__aside__element__data">
        <p class="candidacy__aside__element__data-title">
          <%= t("type", scope: "decidim.signature_collection.candidacies.show") %>
        </p>
        <span class="candidacy__aside__element__data-text text-gray-2">
          <%= render partial: "tags_type", locals: { resource: current_candidacy } %>
        </span>
      </div>

      <% if current_candidacy.area %>
        <div class="candidacy__aside__element__data">
          <p class="candidacy__aside__element__data-title">
            <%= t("area", scope: "decidim.signature_collection.candidacies.show") %>
          </p>
          <span class="candidacy__aside__element__data-text">
            <span class="text-sm font-normal text-gray-2 block">
              <%= link_to translated_attribute(current_candidacy.area_name), candidacies_path(filter: { with_any_area: [current_candidacy.area.id] }) %>
            </span>
          </span>
        </div>
      <% end %>
    </section>
  </section>
<% end %>

<%= participatory_space_floating_help %>

<% if current_candidacy.created? %>
  <% if allowed_to? :send_to_technical_validation, :candidacy, candidacy: current_candidacy %>
    <%= cell("decidim/announcement", t(".send_to_technical_validation_announcement"), callout_class: "success") %>
  <% else %>
    <%= cell("decidim/announcement", t(".before_send_to_technical_validation_announcement",
                                       count: current_candidacy.missing_committee_members,
                                       href: link_to(new_candidacy_committee_request_url(current_candidacy),
                                                     new_candidacy_committee_request_path(current_candidacy))), callout_class: "warning") %>
  <% end %>
<% end %>

<% add_decidim_page_title(translated_attribute(current_candidacy.title)) %>

<section class="layout-main__section layout-main__heading">
  <h2 class="h2 decorator">
    <%= translated_attribute(current_candidacy.title) %>
  </h2>
</section>

<section class="layout-main__section">
  <div class="content-block__description">
    <div class="editor-content">
      <%= decidim_sanitize_editor translated_attribute(current_candidacy.description) %>
    </div>
  </div>
</section>

<section class="layout-main__section">
  <% if tabs.any? %>
    <div class="mt-8" data-component="accordion" data-multiselectable="false" data-collapsible="false">
      <ul class="tab-x-container">
        <% tabs.each_with_index do |tab, i| %>
          <li>
            <button id="trigger-<%= tab[:id] %>" class="tab-x" data-controls="panel-<%= tab[:id] %>" data-open="<%= "true" if i.zero? %>">
              <%= icon tab[:icon], class: "text-gray fill-current" %><%= tab[:text] %>
            </button>
          </li>
        <% end %>
      </ul>

      <% panels.each do |panel| %>
        <div id="panel-<%= panel[:id] %>" class="py-8">
          <%= send(panel[:method], *panel[:args]) %>
        </div>
      <% end %>
    </div>
  <% end %>
</section>

<section class="layout-main__section">
  <%= render partial: "result", locals: { candidacy: current_candidacy } %>
</section>

<section class="layout-main__section layout-main__buttons" data-buttons>
  <% if current_candidacy.commentable? && current_candidacy.published? %>
    <%= cell "decidim/comments_button", nil, display: current_candidacy.commentable? && current_candidacy.published? %>
  <% end %>
  <div class="ml-auto lg:ml-0">
    <%= cell "decidim/share_widget", current_candidacy %>
  </div>
</section>

<section class="layout-main__section layout-item__aside--footer">
  <%= comments_for current_candidacy if current_candidacy.commentable? && current_candidacy.published? %>
  <ul class="metadata__container layout-main__section" data-metadata-footer>
    <%= content_tag :li, resource_reference(current_candidacy), class: "metadata__item" %>
    <%= content_tag :li, resource_version(current_candidacy, versions_path: candidacy_version_path(current_candidacy, current_candidacy.versions.count)), class: "metadata__item" %>
  </ul>
</section>
